
# Saaf Hawa - Design & Architecture Document

This document provides a comprehensive overview of the Saaf Hawa application's architecture, features, and technical implementation.

## 1. Technology Stack

- **Framework**: Next.js (with App Router)
- **Language**: TypeScript
- **UI Library**: React
- **Styling**: Tailwind CSS
- **UI Components**: ShadCN UI
- **Authentication**: Firebase Authentication (Client-side SDK)
- **Mapping**: Leaflet.js
- **Icons**: Lucide React
- **Generative AI / Agent**: AIML API (OpenAI-compatible) for the Hazard Agent.
- **External Data APIs**:
    - Open-Meteo (for air quality data)
    - OpenWeatherMap (for reverse geocoding and weather map layers)
    - NASA FIRMS (for wildfire map layer)
    - OpenAQ (for air quality station map layer)
    - Tavily (for web search in the Hazard Agent)
- **Deployment**: Firebase App Hosting

## 2. Project Structure

The project follows a standard Next.js App Router structure.

```
/
├── src/
│   ├── app/
│   │   ├── (app)/              # Authenticated routes (e.g., /dashboard)
│   │   │   ├── dashboard/
│   │   │   ├── hazard-zones/
│   │   │   ├── recommendations/
│   │   │   ├── health-journal/
│   │   │   ├── carbon-footprint/
│   │   │   ├── challenges/
│   │   │   ├── eco-map/ -> Hazard Agent
│   │   │   ├── education/
│   │   │   └── profile/
│   │   ├── api/                # Server-side API proxy routes
│   │   ├── login/              # Login page
│   │   ├── signup/             # Signup page
│   │   ├── layout.tsx          # Root layout
│   │   └── page.tsx            # Public landing page
│   ├── components/             # Reusable React components
│   │   ├── ui/                 # ShadCN UI components
│   │   ├── dashboard/
│   │   ├── landing/
│   │   └── ... (feature-specific components)
│   ├── firebase/               # Firebase configuration and hooks
│   │   ├── client-provider.tsx # Initializes Firebase on the client
│   │   ├── config.ts           # Firebase project credentials from .env
│   │   └── index.ts            # Barrel file for all Firebase utilities
│   ├── hooks/                  # Custom React hooks (e.g., useAirQualityData)
│   └── lib/                    # Libraries, utils, static data, and types
├── docs/                       # Project documentation
└── ... (config files)
```

## 3. Core Features

### 3.1. Dashboard (`/dashboard`)

- **Description**: Provides a real-time overview of the current Air Quality Index (AQI) for the user's location.
- **Implementation**:
    - `src/app/(app)/dashboard/page.tsx` is the main page component.
    - It uses the browser's **Geolocation API** to get the user's coordinates.
    - An internal API route (`/api/reverse-geo`) is called to convert coordinates to a city name using the **OpenWeatherMap Geocoding API**.
    - The `useAirQualityData` hook (`src/hooks/useAirQualitydata.ts`) fetches live AQI data from another internal API route (`/api/air-quality`), which acts as a proxy to the **Open-Meteo API**.
    - Displays a summary card (`AqiSummaryCard`), a grid of individual pollutants (`PollutantGrid`), and an AI-generated weekly insight (`AqiInsightCard`).
    - The insight is generated by the `getAirQualityInsight` function (`src/ai/flows/air-quality-insights.ts`) using a simple logic based on the change from the previous week's AQI (stored in `localStorage`).

### 3.2. Hazard Zones Map (`/hazard-zones`)

- **Description**: A live, interactive map displaying real-time environmental data layers.
- **Implementation**:
    - `src/app/(app)/hazard-zones/page.tsx` renders the `HazardMapClient` component.
    - `src/components/hazard-zones/HazardMapClient.tsx` uses **Leaflet.js** to create the map.
    - It integrates multiple data sources as toggleable layers:
        - **Wildfires**: Fetches and displays active fire data from the **NASA FIRMS API**.
        - **Air Quality Stations**: Fetches station data from the **OpenAQ API** and plots them as AQI-colored markers.
        - **Weather Layers**: Overlays for temperature, precipitation, clouds, and wind are fetched directly from **OpenWeatherMap** tile servers.
    - Requires `NEXT_PUBLIC_NASA_API_KEY`, `NEXT_PUBLIC_OPENWEATHER_API_KEY`, and `NEXT_PUBLIC_OPENAQ_API_KEY` in `.env` to function correctly.

### 3.3. AI Hazard Agent (`/eco-map`)

- **Description**: An intelligent, conversational AI agent that can be queried about environmental hazards in any location.
- **Implementation**:
    - `src/app/(app)/eco-map/page.tsx` renders the `HazardsAgentClient` component.
    - The client component provides a form that calls the `getHazardInfo` server action in `src/app/(app)/eco-map/actions.ts`.
    - This action uses a multi-step logic:
        1.  First, it tries to get a fast, factual answer from the **Tavily Search API**.
        2.  If that's inconclusive, it tries to get weather data from the **OpenWeatherMap API**.
        3.  As a last resort, it invokes the full LLM agent (`runHazardAgent`).
    - The `runHazardAgent` function uses an **OpenAI-compatible client** pointed at the **AIML API** to perform function-calling with a set of defined tools (`EonetTool`, `UsgsQuakesTool`, `OwmWeatherTool`) to provide a comprehensive answer.

### 3.4. Personalized Health Advice (`/recommendations`)

- **Description**: Offers AI-driven health recommendations based on the current AQI and a user's health profile.
- **Implementation**:
    - `src/app/(app)/recommendations/page.tsx` contains the UI.
    - The `HealthRecsForm` component gets the user's location and fetches the current AQI.
    - It collects the user's age and health conditions and calls the `getHealthRecommendations` server action.
    - This action runs the `personalizedHealthRecommendations` function (`src/ai/flows/personalized-health-recommendations.ts`), which uses a predefined logic tree to generate advice based on the AQI level and user sensitivity.

### 3.5. Health Journal (`/health-journal`)

- **Description**: Allows users to track daily symptoms and correlate them with local air quality.
- **Implementation**:
    - `src/app/(app)/health-journal/page.tsx` orchestrates the `HealthJournal` component.
    - The `HealthJournal` component (`src/components/health-journal/health-journal.tsx`) fetches the user's location and the live AQI using the `useAirQualityData` hook.
    - The `HealthLogForm` allows users to submit symptoms and notes.
    - The `useHealthLog` hook (`src/hooks/use-health-log.ts`) manages storing and retrieving journal entries from the browser's `localStorage`. Each entry is saved with the live AQI at the time of logging.

### 3.6. Carbon Footprint Calculator (`/carbon-footprint`)

- **Description**: An interactive tool to estimate a user's annual carbon footprint and track their progress.
- **Implementation**:
    - The `CalculatorForm` in `src/components/carbon-footprint/calculator-form.tsx` collects detailed lifestyle information.
    - It calls the `getWeeklyFootprint` server action, which runs the `calculateCarbonFootprint` function (`src/ai/flows/carbon-footprint-calculator.ts`).
    - This function uses a set of hardcoded emission factors to calculate the total footprint and generate personalized reduction tips.
    - The `useFootprintHistory` hook (`src/hooks/use-footprint-history.ts`) saves calculation results to `localStorage` to power a progress chart.

### 3.7. Eco-Challenges & Leaderboard (`/challenges`)

- **Description**: A gamified system where users can complete environmental challenges to earn points and badges.
- **Implementation**:
    - The UI is composed of `ChallengeList`, `Leaderboard`, and `MyBadges` components.
    - All challenge and badge data is currently mocked in `src/lib/data.ts`.
    - User progress is managed entirely on the client side using `localStorage` via two custom hooks:
        - `useUserScore`: Tracks the user's total points.
        - `useUserChallenges`: Tracks which challenges the user has completed.
    - Completing a challenge adds points to the user's score and marks the challenge as done.

## 4. Authentication

- **Provider**: Firebase Authentication.
- **Methods**: Email/Password.
- **Implementation**:
    - UI is handled by `src/app/login/page.tsx` and `src/app/signup/page.tsx`.
    - All authentication logic is **client-side**. The forms directly call the Firebase SDK's `signInWithEmailAndPassword` and `createUserWithEmailAndPassword` functions.
    - The `FirebaseProvider` (`src/firebase/provider.tsx`) wraps the application and uses Firebase's `onAuthStateChanged` listener to manage the global user state.
    - The `useUser` hook provides the current user's auth state throughout the app.
    - `AuthLayout` (`src/components/auth-layout.tsx`) protects all routes within the `(app)` directory, redirecting unauthenticated users to the `/login` page.
    - `AuthWatcher` (`src/components/auth-watcher.tsx`) is used on login/signup pages to redirect already authenticated users to the dashboard.
- **User Profile**: The `/profile` page allows users to update their `displayName`. This is handled by a server action (`src/app/(app)/profile/actions.ts`) that calls the Firebase client SDK's `updateProfile` function.
